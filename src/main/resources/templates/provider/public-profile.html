<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <meta charset="UTF-8">
    <title>Provider Profile</title>
    <style>
        .profile-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
        }
        .profile-field {
            margin-bottom: 1.2rem;
        }
        .label {
            font-weight: bold;
            color: #555;
        }
        .value {
            font-size: 1.1rem;
            color: #222;
        }
        .actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-link {
            background-color: #007BFF;
            color: white;
            text-decoration: none;
        }
    </style>
</head>
<body>
<section layout:fragment="content">

    <div class="profile-container">
        <div id="review-modal" style="display: none; position: fixed; top: 0; left: 0;
     width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
            <div style="background: white; padding: 2rem; border-radius: 8px; width: 400px;">
                <h3>Leave a Review</h3>
                <form id="review-form">
                    <div>
                        <label for="review-content">Content:</label><br>
                        <textarea id="review-content" name="content" rows="4" style="width: 100%;"></textarea>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label for="review-stars">Stars (1-5):</label><br>
                        <input type="number" id="review-stars" name="stars" min="1" max="5">
                    </div>
                    <input type="hidden" id="provider-username" th:value="${user.username}">
                    <input type="hidden" id="client-username" th:value="${authentication.getName()}">
                    <button type="submit" class="btn btn-link" style="margin-top: 1rem;">Submit Review</button>
                    <button type="button" onclick="closeReviewModal()" style="margin-left: 1rem;">Cancel</button>
                </form>
            </div>
        </div>

        <h2 th:text="'Provider: ' + ${user.firstName} + ' ' + ${user.lastName}"></h2>


        <div class="profile-field">
            <div class="label">First Name:</div>
            <div class="value" th:text="${user.firstName}">First Name</div>
        </div>

        <div class="profile-field">
            <div class="label">Last Name:</div>
            <div class="value" th:text="${user.lastName}">Last Name</div>
        </div>

        <div class="actions">
            <button th:if="${roles.contains('ROLE_CLIENT')}"
                    th:data-provider-username="${user.username}"
                    th:data-client-username="${authentication.getName()}"
                    onclick="addProviderToClient(this)"
                    class="add-provider-btn">
                Link Provider
            </button>

            <button class="btn btn-link"
                    onclick="openReviewModal()"
                    th:if="${roles.contains('ROLE_CLIENT')}">
                Leave Review
            </button>
        </div>

        <h3>Reviews</h3>
        <div th:if="${reviews.isEmpty()}">
            <p>No reviews yet.</p>
        </div>
        <div th:each="review : ${reviews}" style="border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 6px;" th:attr="data-review-id=${review.id}">
            <p><strong th:text="${review.clientUsername}"></strong></p>

            <p>
                <span class="stars-display" th:text="${#strings.repeat('⭐', review.stars)}"></span>
                <input type="number" min="1" max="5" class="edit-stars" style="display:none;" th:value="${review.stars}">
            </p>

            <p>
                <span class="content-display" th:text="${review.content}"></span>
                <textarea class="edit-content" style="display:none;" rows="3" cols="50" th:text="${review.content}"></textarea>
            </p>

            <div th:if="${review.clientUsername == authentication.getName()}" style="margin-top: 0.5rem;">
                <button class="btn edit-btn" onclick="enableEdit(this)">Edit</button>
                <button class="btn save-btn" style="display:none;" onclick="saveReview(this)">Save</button>
                <button class="btn cancel-btn" style="display:none;" onclick="cancelEdit(this)">Cancel</button>
                <button class="btn" onclick="deleteReview(this)">Delete</button>
            </div>


        </div>
        <h3>Availability Calendar</h3>
        <div th:if="${user.calendar != null and !user.calendar.slots.isEmpty()}">
            <div th:each="slot : ${user.calendar.slots}" style="margin-bottom: 1rem;">
                <div class="label" th:text="${slot.dayOfWeek}">Day</div>
                <div class="value">
                    <ul>
                        <li th:each="time : ${slot.times}" th:text="${time}">09:00</li>
                    </ul>
                </div>
            </div>
        </div>
        <div th:if="${user.calendar == null or user.calendar.slots.isEmpty()}">
            <p>This provider has not set any availability yet.</p>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            function addProviderToClient(button) {
                const clientUsername = button.getAttribute('data-client-username');
                const providerUsername = button.getAttribute('data-provider-username');
                fetch(`/provider/add?clientUsername=${clientUsername}&providerUsername=${providerUsername}`, {
                    method: 'POST'
                })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert("Error adding provider.");
                        }
                    });
            }

            window.addProviderToClient = addProviderToClient;
        });
    </script>

    <script>
        function openReviewModal() {
            document.getElementById('review-modal').style.display = 'flex';
        }

        function closeReviewModal() {
            document.getElementById('review-modal').style.display = 'none';
        }

        document.getElementById('review-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const content = document.getElementById('review-content').value;
            const stars = document.getElementById('review-stars').value;
            const providerUsername = document.getElementById('provider-username').value;
            const clientUsername = document.getElementById('client-username').value;

            fetch('/review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: content,
                    stars: parseInt(stars),
                    providerUsername: providerUsername,
                    clientUsername: clientUsername
                })
            })
                .then(response => {
                    if (response.ok) {
                        alert("Review sent!");
                        closeReviewModal();
                        location.reload();
                    } else {
                        alert("Error submitting review.");
                    }
                });
        });
    </script>

    <script>
        function enableEdit(button) {
            const container = button.closest('[data-review-id]');
            container.querySelector('.stars-display').style.display = 'none';
            container.querySelector('.content-display').style.display = 'none';
            container.querySelector('.edit-stars').style.display = 'inline-block';
            container.querySelector('.edit-content').style.display = 'block';

            container.querySelector('.edit-btn').style.display = 'none';
            container.querySelector('.save-btn').style.display = 'inline-block';
            container.querySelector('.cancel-btn').style.display = 'inline-block';
        }

        function cancelEdit(button) {
            const container = button.closest('[data-review-id]');
            container.querySelector('.stars-display').style.display = 'inline';
            container.querySelector('.content-display').style.display = 'block';
            container.querySelector('.edit-stars').style.display = 'none';
            container.querySelector('.edit-content').style.display = 'none';

            container.querySelector('.edit-btn').style.display = 'inline-block';
            container.querySelector('.save-btn').style.display = 'none';
            container.querySelector('.cancel-btn').style.display = 'none';
        }

        function saveReview(button) {
            const container = button.closest('[data-review-id]');
            const reviewId = container.getAttribute('data-review-id');
            const newStars = container.querySelector('.edit-stars').value;
            const newContent = container.querySelector('.edit-content').value;

            fetch(`/review/${reviewId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    stars: parseInt(newStars),
                    content: newContent
                })
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert("Error updating review.");
                }
            });
        }

        function deleteReview(button) {
            const container = button.closest('[data-review-id]');
            const reviewId = container.getAttribute('data-review-id');

            if (confirm("Are you sure you want to delete this review?")) {
                fetch(`/review/${reviewId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert("Error deleting review.");
                    }
                });
            }
        }
    </script>



</section>
</body>
</html>


